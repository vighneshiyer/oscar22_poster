<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Improving Verification Infrastructure for Chisel RTL — </title>
    <link rel="stylesheet" href="poster.css">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1">
    <!-- Based on a poster template from https://github.com/cpitclaudel/academic-poster-template -->

          <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
              <script type="text/javascript" id="HighlightJS-script" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js" integrity="sha512-yUUc0qWm2rhM7X0EFe82LNnv2moqArj5nro/w1bi05A09hRVeIZbN6jlMoyu0+4I/Bu4Ck/85JQIU82T82M28w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/languages/scala.min.js" integrity="sha512-17yQnEpAzLAY3RDPjYqCLa44Eh+N7uDNoB4aUNneHbs7nF260eUc6mgGpNvEUlTdJQC5hD+fgDK7c5NJ/KDbuQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/languages/verilog.min.js" integrity="sha512-t3zKu+I8HGgPlmP/BA571kXuuhPkhetB6/Q6+/CZJ/v5yf7fx1xkforaFrCEDJEBprrQXW7fXtMKA8CjilibBA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css" integrity="sha512-hasIneQUHlh06VNBe7f6ZcHmeRTLIaQWFd43YriJ0UND19bvYRauxthDg8E4eVNPm9bRUhr5JGeqH7FRFXQu5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/mono-blue.min.css" integrity="sha512-9MaxPqXjPueWIGbV9cvVzkGnBxywb1kSNUtjm5Ttnk0ltKD23voJdHxAh6y9k10CwWwrFiFn49FG88KZuFzbTg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      <script defer>hljs.highlightAll();</script>
              <link href="https://fonts.googleapis.com/css2?family=Fira+Sans+Condensed:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet">
        <style type="text/css">
    html { font-size: 1.15rem }
    .container{
      display: grid;
      grid-auto-flow: column;
      column-gap: 1em;
    }
    th {
      border-bottom: 1px solid;
    }
</style>
  </head>

  <body vocab="http://schema.org/" typeof="ScholarlyArticle">
    <header role="banner">
      <aside>
          <!--<a href="https://github.com/vighneshiyer/simcommand"><img src="logo.svg" alt="Tutorial logo"></a>-->
  <!--<a href="https://github.com/vighneshiyer/simcommand"><img src="chisel_logo.svg" alt="Chisel - chiseltest"></a>-->
  <a href="https://slice.eecs.berkeley.edu"><img style="background: white" src="slice_logo.png" alt="Berkeley SLICE Lab Logo"></a>
      </aside>
      <div>
        <h1 property="headline">Improving Verification Infrastructure for Chisel RTL</h1>
                <address>
              <a property="author" style="font-size:90%;">Vighnesh Iyer, Kevin Laeufer, Rohit Agarwal, Young-Jin Park, Andy Yin, Oliver Yu, Bryan Ngo, Shawn Kong, Grace Chen, Yi Mu, Sungwoong Ha, Bora Nikolic</a>
<br />  <a property="sourceOrganization">UC Berkeley</a>
        </address>
        <span class="publication-info">
                      <span property="publisher">SLICE Winter 2023 Retreat</span>,
            <time pubdate property="datePublished" datetime="2020-09-08">September 8, 2020</time>
                  </span>
      </div>
      <aside>
          <a href="https://berkeley.edu"><img style="background: white" src="berkeley_logo.svg" alt="University of California, Berkeley"></a>
      </aside>
    </header>

    <main property="articleBody">
        <article style="hyphens:none;">
    <header><h3>Motivation</h3></header>
    <ul>
    <li>Move beyond SystemVerilog + UVM without compromising features or performance</li>
    <li>Design new tools that leverage open source hardware generator ecosystems</li>
    </ul>
    </article>

  <!--<article style="hyphens:none;">
  <header><h3>Simulator Independent Coverage</h3></header>
  </article>-->

  <article style="hyphens:none;">
    <header><h3>SimCommand Overview</h3></header>
  <p><strong>Goal:</strong> A Scala-embedded testbench API with fork/join support and performance parity with SystemVerilog testbenches</p>
  <!--<p><strong>Implementation:</strong> fork/join with cooperatively yielding 'threads', leverage chiseltest as simulator API</p>-->
  <ul>
  <li>Separation of description and interpretation of testbench actions</li>
  <li>Threads are just pointers to continuations → fast thread pause/resume</li>
  <li>A <code>Command[R]</code> is a <em>description</em> of testbench actions which terminates with a value of type <code>R</code></li>
  </ul>

<pre class="fragment"><code class="language-scala medium">val program: Command[Boolean] = for {
    _ <- poke(dut.enq.valid, 1.B)
    _ <- step(1)
    p <- peek(dut.deq.valid)
} yield p.litValue == 1</pre></code>

<img class="fragment" src="./command_sequencing.svg"/>
</article>

<article style="hyphens:none;">
<header><h3>SimCommand Channels</h3></header>
<p class="center">Channels enable deterministic thread-to-thread communication, similar to SystemVerilog mailboxes or golang channels.</p>

<pre class="fragment"><code class="language-scala medium">ch <- makeChannel[Integer](size=10)
_ <- put(ch, 1)
t <- fork( for { v <- getBlocking(ch) } yield v )
v <- join(t)
</pre></code>
</article>

<article style="hyphens:none;">
<header><h3>SimCommand Imperative Interpreter</h3></header>
<ul>
<li>Older purely recursive interpreter used no mutable data structures and required unnecessary allocations.</li>
<li>New imperative interpreter maintains an explicit stack per thread and <strong>improves performance by 30%</strong>.</li>
</article>

<article style="hyphens:none;">
<header><h3>SimCommand Tail Recursion Primitive</h3></header>
<ul>
<li>Naive monadic recursion can blow up the stack</li>
<li>One solution is <em>trampolining</em> where the stack is dumped to the heap on every recursive call.</li>
</ul>

<pre class="fragment"><code class="language-scala small">def tailRecM[R, R2](r: R)
  (f: R => Command[Either[R, R2]]): Command[R2] = {
  f(r).flatMap {
    case Left(value) => tailRecM(value)(f)
    case Right(value) => lift(value)
  }
}</pre></code>

<p class="center">However, trampolining is slow. A recursion <em>primitive</em> that elides trampolining demonstrates <strong>400% performance improvement</strong>.</p>
</article>

<article style="hyphens:none;">
  <header><h3>Chiseltest ⬌ RTL Simulator FFI</h3></header>
  <img width="80%" src="./command_interpretation.svg"/>

  <ul>
  <li>The foreign function interface (FFI) linking chiseltest on the JVM and the RTL simulation (Verilator) in C++ is a bottleneck</li>
  <li>Using JNI vs JNA as the FFI API <strong>improves performance by up to 10x</strong> - WIP: integration into chiseltest</li>
  </ul>
  </article>

<article style="hyphens:none;">
  <header><h3>Lightweight "HLS" Recipes for Chisel</h3></header>
  <ul>
  <li>Writing FSMs manually in RTL is error prone and obscures control flow intent</li>
  <li>WIP: a mini-DSL to describe imperative control flow that compiles to Chisel, inspired by Recipes in Blarney HDL</li>
  </ul>
  <pre class="fragment"><code class="language-scala small">axi.ar_ready := 1.B
axi.r_valid := 0.B
val readOnce = Sequential {
  WaitUntil(axi.ar_valid === 1.B)
  Action {
    axi.r_data := mem.read(axi.ar_addr)
    axi.r_valid := 1.B
  }
  WaitUntil(axi.r_ready === 1.B)
  Tick()
}
Forever(readOnce).compile()</pre></code>
</article>

<article style="hyphens:none;">
  <header><h3>"SVA" for Chisel</h3></header>
  <ul>
  <li>Sequence library to describe temporal properties in Chisel</li>
  <li>Supports a subset of linear PSL (sequence combinators + bounded delays + LTL operators)</li>
  <li>2 backends: naive monitor automata synthesis, SPOT-driven optimized automata synthesis</li>
  </ul>
  <pre class="fragment"><code class="language-scala medium">class Example extends Module {
  val a, b = Reg(Bool())
  val c = Reg(UInt(8.W))
  assert(a |=> b)
  assert(a ###1 b |=> (c > 15.U))
}</pre></code>

  <strong>TODO: add picture of automata + PSL representation</strong>
  <strong>TODO: add link to github repo</strong>
  </article>

<!--<article style="hyphens:none;">
  <header><h3>FIRRTL → Graph for Netlist Embedding</h3></header>
  <ul>
  <li></li>
  </ul>
</article>-->

<article style="hyphens:none;">
  <header><h3>Generative Parametric Random Stimulus API</h3></header>
  <p class="center">WIP: <a href="https://github.com/girantinas/randomapi">github.com/girantinas/randomapi</a>. A parameteric hardware stimgen API written in Scala.</p>
  <pre><code class="language-scala medium">enum Operator: case Add, Sub, Mul, Div

def sexpr(operator: Gen[Operator],
  literal1: Gen[Int],
  literal2: Gen[Int]): Gen[SExpr] = for {
    op <- operator
    lit1 <- literal1
    lit2 <- literal2
} yield SExpr.Expression(...)

val opGen = Gen.oneOf(Operator.values)
val lit1 = Gen.range(0, 10)
val lit2 = Gen.range(11, 20)
sexpr(...).generate(ScalaRandom)
sexpr(...).generate(Stream[Byte])</code></pre>
  </article>

  <!--<figure style="flex-grow: 9999999">
    <img style="width: 70%" src="logo.svg" alt="Project logo" />
    <figcaption>A stand-alone figure to fill the remaining space.</figcaption>
    </figure>
    -->
    </main>

    <footer>
      <address class="monospace">  <a href="https://github.com/vighneshiyer/simcommand">https://github.com/vighneshiyer/simcommand</a>
</address>
      <address class="monospace">  vighnesh.iyer@berkeley.edu
</address>
              <span class="credits">
    SLICE Retreat, Winter 2023
  </span>
    </footer>
  </body>
</html>